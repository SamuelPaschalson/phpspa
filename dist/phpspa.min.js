/**
 * phpSPA JavaScript Engine
 *
 * A lightweight JavaScript engine for PHP-powered single-page applications.
 * Handles SPA-style navigation, content replacement, and lifecycle events
 * without full page reloads. Designed to pair with the `phpSPA` PHP framework.
 *
 * Features:
 * - `phpspa.navigate(url, state = "push")`: Navigate to a new route via AJAX.
 * - `phpspa.back()` / `phpspa.forward()`: Navigate browser history.
 * - `phpspa.on("beforeload" | "load", callback)`: Lifecycle event hooks.
 * - Auto-replaces DOM target with component content and updates `<title>` and `<meta>`.
 * - Executes inline component scripts marked as `<script data-type="phpspa/script">`.
 * - Built-in scroll position restoration across route changes.
 *
 * Example Usage:
 * ```js
 * phpspa.on("beforeload", ({ route }) => showSpinner());
 * phpspa.on("load", ({ success }) => hideSpinner());
 * phpspa.navigate("/profile");
 * ```
 *
 * Note:
 * - All scripts and logic must be attached per component using `$component->script(...)`.
 * - This library assumes server-rendered HTML responses with placeholder target IDs.
 *
 * @author Dave Conco
 * @version 1.0.0
 * @license MIT
 */
window.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector("[data-phpspa-target]");if(t){const e={url:location.href,title:document.title,targetID:t.parentElement.id,content:t.innerHTML};history.replaceState(e,document.title,location.href)}})),document.addEventListener("click",(t=>{const e=t.target.closest('a[data-type="phpspa-link-tag"]');e&&(t.preventDefault(),phpspa.navigate(new URL(e.href,location.href),"push"))})),window.addEventListener("popstate",(t=>{const e=t.state;if(e&&e.url&&e.targetID&&e.content){document.title=e.title??document.title;let t=document.getElementById(e.targetID)??document.body;t.innerHTML=e.content,t.querySelectorAll("script[data-type='phpspa/script']").forEach((t=>{const e=document.createElement("script");e.textContent=t.textContent,document.head.appendChild(e).remove()}))}else phpspa.navigate(new URL(location.href),"replace");history.scrollRestoration="auto"}));class phpspa{static get _events(){return{beforeload:[],load:[]}}static navigate(t,e="push"){(async()=>{phpspa.emit("beforeload",{route:t});function n(n){"string"!=typeof n?.title&&"number"!=typeof n?.title||(document.title=n.title);let o=document.getElementById(n?.targetID)??document.getElementById(history.state?.targetID)??document.body;o.innerHTML=n?.content??n;const a={url:t?.href??t,title:n?.title??document.title,targetID:n?.targetID??o.id,content:n?.content??n};"push"===e?history.pushState(a,a.title,t):"replace"===e&&history.replaceState(a,a.title,t);let r=document.getElementById(t?.hash?.substring(1));r&&scroll({top:r.offsetTop}),o.querySelectorAll("script[data-type='phpspa/script']").forEach((t=>{const e=document.createElement("script");e.textContent=t.textContent,document.head.appendChild(e).remove()}))}(await fetch(t,{method:"PHPSPA_GET",mode:"same-origin",keepalive:!0})).text().then((e=>{try{let o=JSON.parse(e);phpspa.emit("load",{route:t,success:!0,error:!1}),n(o)}catch(o){let a=e??"";phpspa.emit("load",{route:t,success:!1,error:o}),n(a)}}))})()}static back(){history.back()}static forward(){history.forward()}static reload(){this.navigate(new URL(location.href),"replace")}static on(t,e){this._events[t]||(this._events[t]=[]),this._events[t].push(e)}static emit(t,e){const n=this._events[t]||[];for(const t of n)"function"==typeof t&&t(e)}}void 0===window.phpspa&&(window.phpspa=phpspa);